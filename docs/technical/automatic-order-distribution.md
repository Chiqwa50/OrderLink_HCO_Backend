# ุชุญุฏูุซ ูุธุงู ุชูุฒูุน ุงูุทูุจุงุช ุงูุชููุงุฆู

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุญุฏูุซ ูุธุงู OrderLink ูุฏุนู ุนูุงูุฉ Many-to-Many ุจูู ุงูุฃูุณุงู ูุงููุณุชูุฏุนุงุชุ ูุน ุฅุถุงูุฉ ููุทู ุชูุฒูุน ุงูุทูุจุงุช ุงูุชููุงุฆู ุนูู ุงููุณุชูุฏุนุงุช ุจูุงุกู ุนูู ุงูููุงุฏ ุงููุทููุจุฉ.

## ๐ ุงูุชุบููุฑุงุช ุงูุฑุฆูุณูุฉ

### 1. ุชุนุฏููุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช (Prisma Schema)

#### ุฌุฏูู ุฌุฏูุฏ: `DepartmentWarehouse`
```prisma
model DepartmentWarehouse {
  id          String   @id @default(uuid())
  departmentId String
  warehouseId String
  priority    Int      @default(1)      // ุฃููููุฉ ุงููุณุชูุฏุน (1 = ุงูุฃุนูู)
  isPrimary   Boolean  @default(false)  // ูู ูู ุงููุณุชูุฏุน ุงูุฑุฆูุณูุ
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  warehouse  Warehouse  @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([departmentId, warehouseId])
  @@map("department_warehouses")
}
```

#### ุชุญุฏูุซุงุช ุนูู ุฌุฏูู `Order`
- ุฅุถุงูุฉ ุญูู `warehouseId` (ุฅุฌุจุงุฑู)
- ุฑุจุท ูู ุทูุจ ุจูุณุชูุฏุน ูุญุฏุฏ

#### ุชุญุฏูุซุงุช ุนูู ุฌุฏูู `Department`
- ุฅุถุงูุฉ ุนูุงูุฉ `departmentWarehouses`

#### ุชุญุฏูุซุงุช ุนูู ุฌุฏูู `Warehouse`
- ุฅุถุงูุฉ ุนูุงูุฉ `departmentWarehouses`
- ุฅุถุงูุฉ ุนูุงูุฉ `orders`

---

## ๐๏ธ ุงูุจููุฉ ุงูุฌุฏูุฏุฉ

### 2. OrderService (ุฎุฏูุฉ ุงูุทูุจุงุช)

**ุงูููู:** `/backend/src/services/orderService.ts`

#### ุงููุธุงุฆู ุงูุฑุฆูุณูุฉ:

##### `createOrder(data: CreateOrderData): Promise<Order[]>`
- **ุงููุธููุฉ:** ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ ูุน ุงูุชูุฒูุน ุงูุชููุงุฆู ุนูู ุงููุณุชูุฏุนุงุช
- **ุงูููุทู:**
  1. ุฌูุจ ุงููุณุชูุฏุนุงุช ุงููุฑุชุจุทุฉ ุจุงููุณู (ูุฑุชุจุฉ ุญุณุจ ุงูุฃููููุฉ)
  2. ุงูุชุญูู ูู ูุฌูุฏ ูุณุชูุฏุนุงุช ูุฑุชุจุทุฉ
  3. ุชูุฒูุน ุงูููุงุฏ ุนูู ุงููุณุชูุฏุนุงุช ุจูุงุกู ุนูู `Item.warehouseId`
  4. ุฅูุดุงุก ุทูุจ ูููุตู ููู ูุณุชูุฏุน
  5. ุชุณุฌูู ุงูุนูููุฉ ูู `OrderHistory`

**ูุซุงู ุนูู ุงูุงุณุชุฎุฏุงู:**
```typescript
const orders = await orderService.createOrder({
  departmentId: "dept-123",
  createdBy: "user-456",
  notes: "ุทูุจ ุนุงุฌู",
  items: [
    { itemName: "ูุงุฏุฉ 1", quantity: 10, unit: "box" },
    { itemName: "ูุงุฏุฉ 2", quantity: 5, unit: "piece" }
  ]
});
```

**ุงูุณููุงุฑูููุงุช:**
- โ **ููุงุฏ ูู ูุณุชูุฏุน ูุงุญุฏ:** ูุชู ุฅูุดุงุก ุทูุจ ูุงุญุฏ
- โ **ููุงุฏ ูู ุนุฏุฉ ูุณุชูุฏุนุงุช:** ูุชู ุฅูุดุงุก ุทูุจ ููู ูุณุชูุฏุน ุชููุงุฆูุงู
- โ **ูุง ููุฌุฏ ูุณุชูุฏุน ูุฑุชุจุท:** ุฑุณุงูุฉ ุฎุทุฃ: "ูุง ููุฌุฏ ูุณุชูุฏุน ูุฑุชุจุท ุจูุฐุง ุงููุณู"
- โ **ูุงุฏุฉ ูู ูุณุชูุฏุน ุบูุฑ ูุฑุชุจุท:** ุฑุณุงูุฉ ุฎุทุฃ ูุน ุงุณู ุงููุงุฏุฉ

##### `getOrders(filters): Promise<Order[]>`
- ุฏุนู ููุชุฑุฉ ุญุณุจ:
  - `departmentId`
  - `warehouseId`
  - `status`
  - `userRole`

##### `getOrderById(id: string): Promise<Order | null>`
- ุฌูุจ ุทูุจ ูุญุฏุฏ ูุน ุฌููุน ุงูุชูุงุตูู

##### `updateOrderStatus(orderId, status, changedBy, notes): Promise<Order>`
- ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ ูุน ุชุณุฌูู ูู History

---

### 3. DepartmentService (ุฎุฏูุฉ ุงูุฃูุณุงู)

**ุงูููู:** `/backend/src/services/departmentService.ts`

#### ุงูุชุญุฏูุซุงุช:

##### ูุงุฌูุงุช ุฌุฏูุฏุฉ:
```typescript
interface CreateDepartmentData {
  name: string;
  code: string;
  description?: string;
  warehouses?: {
    warehouseId: string;
    priority: number;
    isPrimary: boolean;
  }[];
}

interface UpdateDepartmentData {
  name?: string;
  code?: string;
  description?: string;
  warehouses?: {
    warehouseId: string;
    priority: number;
    isPrimary: boolean;
  }[];
}
```

##### ูุธุงุฆู ุฌุฏูุฏุฉ:

**`getDepartmentWarehouses(departmentId: string)`**
- ุฌูุจ ุงููุณุชูุฏุนุงุช ุงููุฑุชุจุทุฉ ุจูุณู ูุนูู
- ูุฑุชุจุฉ ุญุณุจ ุงูุฃููููุฉ ุชุตุงุนุฏูุงู

**`linkWarehouseToDepartment(departmentId, warehouseId, priority, isPrimary)`**
- ุฑุจุท ูุณุชูุฏุน ุจูุณู

**`unlinkWarehouseFromDepartment(departmentId, warehouseId)`**
- ุฅูุบุงุก ุฑุจุท ูุณุชูุฏุน ูู ูุณู

##### ุชุญุฏูุซุงุช ุนูู ุงููุธุงุฆู ุงูููุฌูุฏุฉ:

**`createDepartment(data)`**
- ุฏุนู ุฑุจุท ุงููุณุชูุฏุนุงุช ุนูุฏ ุฅูุดุงุก ุงููุณู

**`updateDepartment(id, data)`**
- ุฏุนู ุชุญุฏูุซ ุงููุณุชูุฏุนุงุช ุงููุฑุชุจุทุฉ
- ุญุฐู ุงูุฑูุงุจุท ุงููุฏููุฉ ูุฅุถุงูุฉ ุงูุฌุฏูุฏุฉ

**`deleteDepartment(id)`**
- ุญุฐู ุฑูุงุจุท ุงููุณุชูุฏุนุงุช ูุจู ุญุฐู ุงููุณู

---

### 4. ItemService (ุฎุฏูุฉ ุงูููุงุฏ)

**ุงูููู:** `/backend/src/services/itemService.ts`

#### ูุธุงุฆู ุฌุฏูุฏุฉ:

##### `getItemsForDepartment(departmentId: string): Promise<Item[]>`
- **ุงููุธููุฉ:** ุฌูุจ ุงูููุงุฏ ุงููุชุงุญุฉ ููุณู ูุนูู
- **ุงูููุทู:**
  1. ุฌูุจ ุงููุณุชูุฏุนุงุช ุงููุฑุชุจุทุฉ ุจุงููุณู
  2. ุฌูุจ ุงูููุงุฏ ูู ูุฐู ุงููุณุชูุฏุนุงุช ููุท
  3. ุชุฑุชูุจ ุงูููุงุฏ ุญุณุจ ุงููุณุชูุฏุน ุซู ุงูุงุณู

**ูุซุงู:**
```typescript
const items = await itemService.getItemsForDepartment("dept-123");
// ูุนูุฏ ููุท ุงูููุงุฏ ูู ุงููุณุชูุฏุนุงุช ุงููุฑุชุจุทุฉ ุจุงููุณู
```

##### `getItemsByWarehouse(warehouseId: string): Promise<Item[]>`
- ุฌูุจ ุงูููุงุฏ ุญุณุจ ุงููุณุชูุฏุน

---

### 5. OrderController (ูุชุญูู ุงูุทูุจุงุช)

**ุงูููู:** `/backend/src/controllers/orderController.ts`

#### ุงูุชุญุฏูุซุงุช:

##### `createOrder`
- ุงุณุชุฎุฏุงู `orderService.createOrder()` ุจุฏูุงู ูู ุงูููุทู ุงููุจุงุดุฑ
- ุฅุฑุฌุงุน ุนุฏุฏ ุงูุทูุจุงุช ุงูููุดุฃุฉ
- ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ

**ุงูุงุณุชุฌุงุจุฉ:**
```json
{
  "message": "ุชู ุฅูุดุงุก 2 ุทูุจุงุช ูุชูุฒูุนูุง ุนูู ุงููุณุชูุฏุนุงุช ุจูุฌุงุญ",
  "orders": [...],
  "count": 2
}
```

##### `getOrders`
- ุฏุนู ููุชุฑุฉ ุงููุณุชูุฏุนุงุช ููุณุชุฎุฏูู WAREHOUSE
- ุงุณุชุฎุฏุงู `orderService.getOrders()`

---

## ๐ ุณูุฑ ุงูุนูู (Workflow)

### ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ:

```
1. ูุณุชุฎุฏู ุงููุณู ูุฑุณู ุทูุจ
   โ
2. ุงูุชุญูู ูู ุงูุตูุงุญูุงุช ูุงููุณู
   โ
3. ุฌูุจ ุงููุณุชูุฏุนุงุช ุงููุฑุชุจุทุฉ ุจุงููุณู
   โ
4. ุงูุชุญูู ูู ูุฌูุฏ ูุณุชูุฏุนุงุช
   โ
5. ููู ูุงุฏุฉ ูู ุงูุทูุจ:
   - ุงูุจุญุซ ุนู ุงููุงุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
   - ุงูุญุตูู ุนูู warehouseId
   - ุงูุชุญูู ูู ุฃู ุงููุณุชูุฏุน ูุฑุชุจุท ุจุงููุณู
   - ุชุฌููุน ุงูููุงุฏ ุญุณุจ ุงููุณุชูุฏุน
   โ
6. ููู ูุณุชูุฏุน:
   - ุฅูุดุงุก ุทูุจ ูููุตู
   - ุฅุถุงูุฉ ุงูููุงุฏ ุงูุฎุงุตุฉ ุจู
   - ุชุณุฌูู ูู History
   โ
7. ุฅุฑุฌุงุน ุฌููุน ุงูุทูุจุงุช ุงูููุดุฃุฉ
```

---

## ๐ ุงูุตูุงุญูุงุช ูุงูููุชุฑุฉ

### ูุณุชุฎุฏู ุงููุณู (DEPARTMENT)
- **ุฅูุดุงุก ุงูุทูุจุงุช:** โ
- **ุนุฑุถ ุงูุทูุจุงุช:** ููุท ุทูุจุงุช ูุณูู
- **ุนุฑุถ ุงูููุงุฏ:** ููุท ูู ุงููุณุชูุฏุนุงุช ุงููุฑุชุจุทุฉ ุจูุณูู

### ูุณุชุฎุฏู ุงููุณุชูุฏุน (WAREHOUSE)
- **ุฅูุดุงุก ุงูุทูุจุงุช:** โ
- **ุนุฑุถ ุงูุทูุจุงุช:** ููุท ุงูุทูุจุงุช ุงูููุฌูุฉ ููุณุชูุฏุนู
- **ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ:** โ

### ุงูุณุงุฆู (DRIVER)
- **ุนุฑุถ ุงูุทูุจุงุช:** ููุท READY ู DELIVERED

### ุงููุณุคูู (ADMIN)
- **ูู ุงูุตูุงุญูุงุช:** โ

---

## ๐ฏ ุฃูุซูุฉ ุนูููุฉ

### ูุซุงู 1: ุฅูุดุงุก ูุณู ูุน ุฑุจุท ูุณุชูุฏุนุงุช

```typescript
const department = await departmentService.createDepartment({
  name: "ูุณู ุงูุทูุงุฑุฆ",
  code: "EMRG",
  description: "ูุณู ุงูุทูุงุฑุฆ ุงูุฑุฆูุณู",
  warehouses: [
    {
      warehouseId: "warehouse-1",
      priority: 1,
      isPrimary: true
    },
    {
      warehouseId: "warehouse-2",
      priority: 2,
      isPrimary: false
    }
  ]
});
```

### ูุซุงู 2: ุฅูุดุงุก ุทูุจ ูุชู ุชูุฒูุนู ุชููุงุฆูุงู

**ุงูุณููุงุฑูู:**
- ุงููุณู ูุฑุชุจุท ุจูุณุชูุฏุนูู: "ุตูุฏููุฉ" ู "ููุฌุณุชู"
- ุงูููุงุฏ ุงููุทููุจุฉ:
  - ุฏูุงุก A (ูู ูุณุชูุฏุน ุงูุตูุฏููุฉ)
  - ุฏูุงุก B (ูู ูุณุชูุฏุน ุงูุตูุฏููุฉ)
  - ููุงุฒุงุช (ูู ุงููุณุชูุฏุน ุงูููุฌุณุชู)

**ุงูุทูุจ:**
```typescript
const orders = await orderService.createOrder({
  departmentId: "dept-emergency",
  createdBy: "user-123",
  items: [
    { itemName: "ุฏูุงุก A", quantity: 10, unit: "box" },
    { itemName: "ุฏูุงุก B", quantity: 5, unit: "box" },
    { itemName: "ููุงุฒุงุช", quantity: 100, unit: "piece" }
  ]
});
```

**ุงููุชูุฌุฉ:**
```json
[
  {
    "id": "order-1",
    "orderNumber": "ORD-20251201-0001",
    "warehouseId": "warehouse-pharmacy",
    "items": [
      { "itemName": "ุฏูุงุก A", "quantity": 10 },
      { "itemName": "ุฏูุงุก B", "quantity": 5 }
    ]
  },
  {
    "id": "order-2",
    "orderNumber": "ORD-20251201-0002",
    "warehouseId": "warehouse-logistics",
    "items": [
      { "itemName": "ููุงุฒุงุช", "quantity": 100 }
    ]
  }
]
```

### ูุซุงู 3: ุฌูุจ ุงูููุงุฏ ุงููุชุงุญุฉ ููุณู

```typescript
// ุงููุณู ูุฑุชุจุท ุจูุณุชูุฏุนูู ููุท
const items = await itemService.getItemsForDepartment("dept-123");

// ูุนูุฏ ููุท ุงูููุงุฏ ูู ุงููุณุชูุฏุนุงุช ุงููุฑุชุจุทุฉ
// ูุฑุชุจุฉ ุญุณุจ ุงููุณุชูุฏุน ุซู ุงูุงุณู
```

---

## ๐จ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

### ุฎุทุฃ: ูุง ููุฌุฏ ูุณุชูุฏุน ูุฑุชุจุท
```json
{
  "error": "ูุง ููุฌุฏ ูุณุชูุฏุน ูุฑุชุจุท ุจูุฐุง ุงููุณูุ ุงูุฑุฌุงุก ูุฑุงุฌุนุฉ ุงูุฅุฏุงุฑุฉ"
}
```

### ุฎุทุฃ: ูุงุฏุฉ ูู ูุณุชูุฏุน ุบูุฑ ูุฑุชุจุท
```json
{
  "error": "ุงููุงุฏุฉ \"ุฏูุงุก X\" ุชูุชูู ููุณุชูุฏุน ุบูุฑ ูุฑุชุจุท ุจูุฐุง ุงููุณู"
}
```

### ุฎุทุฃ: ูุงุฏุฉ ุบูุฑ ููุฌูุฏุฉ
```json
{
  "error": "ุงููุงุฏุฉ \"ูุงุฏุฉ Y\" ุบูุฑ ููุฌูุฏุฉ ุฃู ุบูุฑ ูุดุทุฉ"
}
```

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ุงูุฃููููุฉ (Priority):**
   - ุฑูู ุฃูู = ุฃููููุฉ ุฃุนูู
   - ูุชู ุชุฑุชูุจ ุงููุณุชูุฏุนุงุช ุชุตุงุนุฏูุงู ุญุณุจ ุงูุฃููููุฉ

2. **ุงููุณุชูุฏุน ุงูุฑุฆูุณู (isPrimary):**
   - ูููู ุชุนููู ูุณุชูุฏุน ูุงุญุฏ ููุท ูุฑุฆูุณู ููู ูุณู
   - ูุณุชุฎุฏู ูู ุงููุงุฌูุฉ ุงูุฃูุงููุฉ ูุนุฑุถ ุงููุณุชูุฏุน ุงูุงูุชุฑุงุถู

3. **ุงูุชูุฒูุน ุงูุชููุงุฆู:**
   - ูุชู ุชููุงุฆูุงู ุจูุงุกู ุนูู `Item.warehouseId`
   - ูุง ูุญุชุงุฌ ุงููุณุชุฎุฏู ูุชุญุฏูุฏ ุงููุณุชูุฏุน

4. **ุงูุญุฐู ุงูุขูู:**
   - ุนูุฏ ุญุฐู ูุณูุ ูุชู ุญุฐู ุฑูุงุจุท ุงููุณุชูุฏุนุงุช ุชููุงุฆูุงู (CASCADE)
   - ุนูุฏ ุญุฐู ูุณุชูุฏุนุ ูุชู ุญุฐู ุงูุฑูุงุจุท ุชููุงุฆูุงู (CASCADE)

---

## ๐ Migration

**ุงูููู:** `20251201103129_add_department_warehouse_relation`

- ุฅูุดุงุก ุฌุฏูู `department_warehouses`
- ุฅุถุงูุฉ `warehouseId` ุฅูู ุฌุฏูู `orders`
- ุฅุถุงูุฉ Foreign Keys
- ูุนุงูุฌุฉ ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ ูุณุจูุงู

---

## โ ุงูุฎุทูุงุช ุงูุชุงููุฉ ุงูููุชุฑุญุฉ

1. **Frontend:**
   - ุชุญุฏูุซ ูุงุฌูุฉ ุฅูุดุงุก/ุชุนุฏูู ุงููุณู ูุฏุนู ุฑุจุท ุงููุณุชูุฏุนุงุช
   - ุฅุฎูุงุก ุฎูุงุฑ ุงุฎุชูุงุฑ ุงููุณุชูุฏุน ูู ูุงุฌูุฉ ุฅูุดุงุก ุงูุทูุจ
   - ุนุฑุถ ุงูููุงุฏ ุงููุชุงุญุฉ ููุท ูู ุงููุณุชูุฏุนุงุช ุงููุฑุชุจุทุฉ

2. **API Endpoints:**
   - `GET /api/departments/:id/warehouses` - ุฌูุจ ูุณุชูุฏุนุงุช ุงููุณู
   - `POST /api/departments/:id/warehouses` - ุฑุจุท ูุณุชูุฏุน
   - `DELETE /api/departments/:id/warehouses/:warehouseId` - ุฅูุบุงุก ุงูุฑุจุท
   - `GET /api/items/department/:departmentId` - ุฌูุจ ููุงุฏ ุงููุณู

3. **Validation:**
   - ุงูุชุญูู ูู ุนุฏู ุชูุฑุงุฑ ุงูุฃููููุงุช
   - ุงูุชุญูู ูู ูุฌูุฏ ูุณุชูุฏุน ุฑุฆูุณู ูุงุญุฏ ููุท

4. **Testing:**
   - ุงุฎุชุจุงุฑ ุชูุฒูุน ุงูุทูุจุงุช
   - ุงุฎุชุจุงุฑ ุงูููุชุฑุฉ
   - ุงุฎุชุจุงุฑ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

1. `/backend/prisma/schema.prisma` - Schema ุงูุชุญุฏูุซุงุช
2. `/backend/src/services/orderService.ts` - ุฎุฏูุฉ ุฌุฏูุฏุฉ
3. `/backend/src/services/departmentService.ts` - ุชุญุฏูุซุงุช
4. `/backend/src/services/itemService.ts` - ูุธุงุฆู ุฌุฏูุฏุฉ
5. `/backend/src/controllers/orderController.ts` - ุชุญุฏูุซุงุช

---

**ุชุงุฑูุฎ ุงูุชุญุฏูุซ:** 2025-12-01  
**ุงูุฅุตุฏุงุฑ:** 2.0.0  
**ุงููุทูุฑ:** OrderLink Development Team
