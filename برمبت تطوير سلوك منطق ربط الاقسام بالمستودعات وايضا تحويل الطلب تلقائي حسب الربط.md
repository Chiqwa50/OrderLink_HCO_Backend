- ## ✅ البرومبت النهائي (جاهز للنسخ واللصق)

  ```
  أنت مطور خبير في أنظمة إدارة المستودعات (Warehouse Management Systems)
  وتعمل الآن على مشروع اسمه OrderLink مبني بالتالي:
  
  Backend:
  - Node.js + Express
  - TypeScript
  - Prisma ORM
  - PostgreSQL
  - JWT Authentication
  
  النظام يحتوي على:
  - Departments (الأقسام)
  - Warehouses (المستودعات)
  - Items (المواد / الأصناف)
  - Orders (الطلبيات)
  
  حالياً:
  - كل مادة (Item) مرتبطة بمستودع واحد إلزامياً (warehouse_id)
  - يوجد إدارة تتحكم في إنشاء:
    - الأقسام
    - المستودعات
    - المواد
  
  المطلوب منك الآن تعديل سلوك النظام كالتالي:
  
  1. إنشاء علاقة Many-to-Many بين:
     Department ↔ Warehouse
     في جدول وسيط اسمه: DepartmentWarehouse
  
  2. جدول DepartmentWarehouse يجب أن يحتوي على:
     - id
     - department_id
     - warehouse_id
     - priority (رقم يعبر عن أولوية هذا المستودع لهذا القسم)
     - is_primary (قيمة true/false)
  
  3. عند إنشاء أو تعديل قسم (Department) من لوحة الإدارة:
     يجب أن تتوفر إمكانية:
     - ربط هذا القسم بمستودع واحد أو أكثر
     - ترتيب المستودعات حسب الأولوية
     - تعيين مستودع رئيسي (Primary)
  
  4. عند قيام مستخدم القسم بإنشاء طلبية (POST /api/orders):
     يجب على النظام أن يقوم تلقائياً بالآتي:
  
     أ. جلب المستودعات المرتبطة بهذا القسم من جدول DepartmentWarehouse
     ب. ترتيب المستودعات تصاعدياً حسب priority
     ج. فحص المواد المطلوبة في الطلبية وربطها بمستودعاتها (من خلال Item.warehouse_id)
     د. تقسيم الطلب تلقائياً إلى أكثر من طلب إذا كانت المواد من أكثر من مستودع
     هـ. إذا كانت كل المواد من نفس المستودع:
         يتم إنشاء Order واحد وربطه بهذا المستودع
     و. إذا لم يكن هناك مستودع مرتبط بالقسم:
         يمنع إنشاء الطلب وتظهر رسالة: 
         "لا يوجد مستودع مرتبط بهذا القسم، الرجاء مراجعة الإدارة"
  
  5. في واجهة مستخدم القسم (Frontend / Mobile App):
     - لا يجب أن يظهر خيار اختيار المستودع
     - عند عرض المواد للاختيار:
       يُعرض فقط المواد التي تنتمي إلى المستودعات المرتبطة بهذا القسم
       ويتم ترتيبها حسب أولوية المستودعات
  
  6. في واجهة المستودع (Warehouse UI):
     يرى فقط الطلبات التي تم توجيهها إليه (order.warehouse_id = user.warehouse_id)
  
  7. أضف تعديلًا على Prisma schema ليشمل:
     model DepartmentWarehouse { ... }
     مع العلاقات اللازمة.
  
  8. حدّث Service إنشاء الطلب بحيث:
     - يدعم توزيع الطلب على عدة مستودعات تلقائياً
     - يسجل مستودع كل طلب بوضوح
     - يسجل هذه العملية في History
  
  نفّذ التغييرات باحترافية وبما يتماشى مع بنية المشروع الحالية بدون كسر الوظائف السابقة.
  أنشئ الكود كاملاً للتعديل على:
  - Prisma schema
  - Order service
  - Department controller
  - Order controller
  - Query تصفية المواد حسب القسم والمستودع
  
  وأظهر مثالًا واضحًا للمنطق البرمجي في TypeScript
  ```

  ------

  ## ✅ ماذا سيحقق لك هذا السلوك؟

  - كل قسم يرى المواد فقط من مستودعاته ✅
  - الطلب يذهب تلقائياً للمستودع الصحيح ✅
  - دعم توزيع طلب واحد إلى عدة مستودعات ✅
  - أولوية في التوجيه حسب أهمية المستودع ✅
  - منع الأخطاء البشرية ✅
  - نظام احترافي قابل للتوسع ✅